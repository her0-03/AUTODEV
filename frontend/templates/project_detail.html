<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project.name }} - AutoDev</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/ui-enhancements.js') }}"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <a href="{{ url_for('dashboard') }}" class="p-2 hover:bg-gray-100 rounded-lg transition">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </a>
                    <div class="h-8 w-px bg-gray-300"></div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">{{ project.name }}</h1>
                        <p class="text-xs text-gray-500">{{ project.description or 'Aucune description' }}</p>
                    </div>
                </div>
                <div id="autoSaveIndicator" class="text-sm text-gray-500"></div>
            </div>
        </div>
    </nav>
    
    <div class="container mx-auto px-6 py-8">
        <!-- Progress Steps -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="flex items-center">
                        <div class="flex items-center text-blue-600 relative">
                            <div class="rounded-full h-12 w-12 flex items-center justify-center bg-blue-600 text-white font-bold">
                                1
                            </div>
                            <div class="absolute top-0 -ml-10 text-center mt-16 w-32 text-xs font-medium">üìÑ Upload</div>
                        </div>
                        <div class="flex-auto border-t-2 border-blue-600"></div>
                        <div class="flex items-center text-gray-400 relative">
                            <div class="rounded-full h-12 w-12 flex items-center justify-center bg-gray-200 font-bold">
                                2
                            </div>
                            <div class="absolute top-0 -ml-10 text-center mt-16 w-32 text-xs font-medium">ü§ñ Analyse</div>
                        </div>
                        <div class="flex-auto border-t-2 border-gray-300"></div>
                        <div class="flex items-center text-gray-400 relative">
                            <div class="rounded-full h-12 w-12 flex items-center justify-center bg-gray-200 font-bold">
                                3
                            </div>
                            <div class="absolute top-0 -ml-10 text-center mt-16 w-32 text-xs font-medium">üîç Preview</div>
                        </div>
                        <div class="flex-auto border-t-2 border-gray-300"></div>
                        <div class="flex items-center text-gray-400 relative">
                            <div class="rounded-full h-12 w-12 flex items-center justify-center bg-gray-200 font-bold">
                                4
                            </div>
                            <div class="absolute top-0 -ml-10 text-center mt-16 w-32 text-xs font-medium">üöÄ G√©n√©rer</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Upload Section -->
        <div class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100 mb-6">
            <div class="flex items-center gap-3 mb-6">
                <div class="p-3 bg-blue-100 rounded-xl">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">√âtape 1: Upload des documents</h3>
                    <p class="text-gray-500 text-sm">PDF, Word, Excel, Images - Glissez-d√©posez vos fichiers</p>
                </div>
            </div>
            
            <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-blue-500 transition cursor-pointer" 
                 id="dropZone"
                 ondrop="handleDrop(event)" 
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-gray-600 font-medium mb-2">Glissez-d√©posez vos fichiers ici</p>
                <p class="text-gray-400 text-sm mb-4">ou</p>
                <label class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 cursor-pointer transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Parcourir les fichiers
                    <input type="file" id="fileInput" multiple class="hidden" onchange="handleFileSelect(event)">
                </label>
                <p class="text-xs text-gray-400 mt-4">Formats support√©s: PDF, DOCX, XLSX, PNG, JPG</p>
            </div>
            
            <div id="fileList" class="mt-4 space-y-2"></div>
            
            <button onclick="uploadFiles()" id="uploadBtn" disabled
                class="mt-4 w-full flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-semibold hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                Uploader les fichiers
            </button>
        </div>
        
        <!-- Analysis Section -->
        <div class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100 mb-6">
            <div class="flex items-center gap-3 mb-6">
                <div class="p-3 bg-purple-100 rounded-xl">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">√âtape 2: Analyse IA</h3>
                    <p class="text-gray-500 text-sm">L'IA extrait automatiquement les sp√©cifications</p>
                </div>
            </div>
            
            <div class="flex gap-3 mb-4">
                <button onclick="startAnalysis()" class="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Lancer l'analyse
                </button>
                <button onclick="saveSpec()" class="px-6 py-3 bg-yellow-500 text-white rounded-xl font-semibold hover:bg-yellow-600 transition">
                    üíæ Sauvegarder
                </button>
                <button onclick="previewSpec()" class="px-6 py-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition">
                    üîç Preview
                </button>
            </div>
            
            <div id="analysisOutput" class="bg-gray-900 text-green-400 p-6 rounded-xl font-mono text-sm overflow-auto max-h-96 min-h-32">
                <div class="flex items-center gap-2 text-gray-500">
                    <svg class="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    En attente de l'analyse...
                </div>
            </div>
        </div>
        
        <!-- Preview Section -->
        <div id="previewSection" class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100 mb-6 hidden">
            <div class="flex items-center gap-3 mb-6">
                <div class="p-3 bg-indigo-100 rounded-xl">
                    <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">√âtape 3: Aper√ßu du projet</h3>
                    <p class="text-gray-500 text-sm">V√©rifiez les sp√©cifications extraites</p>
                </div>
            </div>
            <div id="previewContent" class="space-y-4"></div>
            <div id="analyticsContent" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6"></div>
        </div>
        
        <!-- Customization Section -->
        <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl p-8 shadow-sm border border-purple-100 mb-6">
            <div class="flex items-center gap-3 mb-6">
                <div class="p-3 bg-white rounded-xl shadow-sm">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">üé® Personnalisation avanc√©e</h3>
                    <p class="text-gray-600 text-sm">Ajoutez des fonctionnalit√©s suppl√©mentaires</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="useTemplate()" class="flex items-center gap-3 bg-white p-4 rounded-xl hover:shadow-md transition border border-purple-100">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    <div class="text-left">
                        <div class="font-semibold text-gray-800">üì¶ Templates</div>
                        <div class="text-xs text-gray-500">Utiliser un template pr√©-configur√©</div>
                    </div>
                </button>
                
                <button onclick="openVisualEditor()" class="flex items-center gap-3 bg-white p-4 rounded-xl hover:shadow-md transition border border-blue-100">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </div>
                    <div class="text-left">
                        <div class="font-semibold text-gray-800">‚úèÔ∏è √âditeur visuel</div>
                        <div class="text-xs text-gray-500">Modifier visuellement</div>
                    </div>
                </button>
                
                <button onclick="addIntegration('oauth')" class="flex items-center gap-3 bg-white p-4 rounded-xl hover:shadow-md transition border border-green-100">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <div class="text-left">
                        <div class="font-semibold text-gray-800">üîê OAuth</div>
                        <div class="text-xs text-gray-500">Authentification sociale</div>
                    </div>
                </button>
                
                <button onclick="addIntegration('stripe')" class="flex items-center gap-3 bg-white p-4 rounded-xl hover:shadow-md transition border border-yellow-100">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                    </div>
                    <div class="text-left">
                        <div class="font-semibold text-gray-800">üí≥ Paiements</div>
                        <div class="text-xs text-gray-500">Int√©gration Stripe</div>
                    </div>
                </button>
            </div>
        </div>
        
        <!-- Generation Section -->
        <div class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100">
            <div class="flex items-center gap-3 mb-6">
                <div class="p-3 bg-green-100 rounded-xl">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">√âtape 4: G√©n√©ration & D√©ploiement</h3>
                    <p class="text-gray-500 text-sm">Cr√©ez votre application compl√®te</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <button onclick="generateCode()" class="flex items-center justify-center gap-2 px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-semibold hover:shadow-lg transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    G√©n√©rer le projet
                </button>
                
                <button onclick="runSecurityScan()" class="flex items-center justify-center gap-2 px-6 py-4 bg-red-600 text-white rounded-xl font-semibold hover:bg-red-700 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                    üîí Scan de s√©curit√©
                </button>
            </div>
            
            <button onclick="openExistingEditor()" class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                ‚úèÔ∏è Ouvrir dans l'√©diteur
            </button>
            
            <div id="downloadLink" class="mt-4"></div>
            <div id="securityResults" class="mt-4 hidden"></div>
        </div>
    </div>
    
    <!-- Generation Progress Modal -->
    <div id="generationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 modal-container">
        <div class="modal-content bg-white rounded-2xl p-6 sm:p-8 max-w-2xl shadow-2xl">
            <div class="text-center mb-6">
                <div class="inline-block p-4 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full mb-4">
                    <svg class="w-12 h-12 text-white animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <h3 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">üöÄ G√©n√©ration en cours...</h3>
                <p class="text-sm sm:text-base text-gray-500">Cr√©ation de votre application compl√®te</p>
            </div>
            
            <div id="generationSteps" class="space-y-2 sm:space-y-3 mb-6 max-h-60 sm:max-h-96 overflow-y-auto"></div>
            
            <div class="mt-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs sm:text-sm font-medium text-gray-600">Progression</span>
                    <span id="progressText" class="text-xs sm:text-sm font-bold text-blue-600">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 sm:h-3 overflow-hidden">
                    <div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-purple-600 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Projects List Modal -->
    <div id="projectsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 modal-container">
        <div class="modal-content bg-white rounded-2xl p-6 sm:p-8 max-w-3xl shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-xl sm:text-2xl font-bold text-gray-800">üìÅ Projets g√©n√©r√©s</h3>
                    <p class="text-xs sm:text-sm text-gray-500">S√©lectionnez un projet pour l'ouvrir</p>
                </div>
                <button onclick="closeProjectsModal()" class="p-2 hover:bg-gray-100 rounded-lg transition">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="projectsList" class="space-y-3"></div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/sse-handler.js') }}"></script>
    <script>
        const projectId = '{{ project.id }}';
        const token = '{{ session.token }}';
        let jobId = null;
        let selectedFiles = [];
        
        // Drag & Drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.add('border-blue-500', 'bg-blue-50');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('border-blue-500', 'bg-blue-50');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('border-blue-500', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            handleFiles(files);
        }
        
        function handleFileSelect(e) {
            handleFiles(e.target.files);
        }
        
        function handleFiles(files) {
            selectedFiles = Array.from(files);
            displayFileList();
            document.getElementById('uploadBtn').disabled = false;
        }
        
        function displayFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = selectedFiles.map((file, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex items-center gap-3">
                        <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        <div>
                            <div class="font-medium text-gray-800">${file.name}</div>
                            <div class="text-xs text-gray-500">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button onclick="removeFile(${index})" class="p-2 hover:bg-red-100 rounded-lg transition">
                        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }
        
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayFileList();
            if (selectedFiles.length === 0) {
                document.getElementById('uploadBtn').disabled = true;
            }
        }
        
        async function uploadFiles() {
            if (selectedFiles.length === 0) {
                showToast('‚ö†Ô∏è Veuillez s√©lectionner des fichiers', 'error');
                return;
            }
            
            showLoading('Upload des fichiers en cours...');
            
            const formData = new FormData();
            selectedFiles.forEach(file => formData.append('files', file));
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/upload', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });
                
                const data = await response.json();
                
                // Create job with uploaded files
                const jobResponse = await fetch('http://localhost:8000/api/v1/generation/job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ 
                        project_id: projectId,
                        input_files: data.files 
                    })
                });
                
                const jobData = await jobResponse.json();
                jobId = jobData.id;
                
                hideLoading();
                showToast('‚úÖ Fichiers upload√©s avec succ√®s!', 'success');
            } catch (error) {
                hideLoading();
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        function startAnalysis() {
            if (!jobId) {
                showToast('‚ö†Ô∏è Veuillez d\'abord uploader des fichiers', 'error');
                return;
            }
            
            const output = document.getElementById('analysisOutput');
            output.innerHTML = '<div class="flex items-center gap-2"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-green-400"></div><span>Analyse en cours...</span></div>';
            window.fullResponse = '';
            
            const eventSource = new EventSource('http://localhost:8000/api/v1/generation/analyze-stream/' + jobId + '?token=' + token);
            
            eventSource.onmessage = function(event) {
                if (window.fullResponse === '') {
                    output.innerHTML = '';
                }
                output.innerHTML += event.data;
                window.fullResponse += event.data;
                output.scrollTop = output.scrollHeight;
            };
            
            eventSource.onerror = function() {
                eventSource.close();
                output.innerHTML += '\n\n<div class="text-yellow-400 mt-4">‚úÖ Analyse termin√©e - Sauvegarde...</div>';
                setTimeout(() => saveSpec(), 1000);
            };
        }
        
        function saveSpec() {
            if (!window.fullResponse) {
                showToast('‚ö†Ô∏è Aucune donn√©e d\'analyse √† sauvegarder', 'error');
                return;
            }
            
            try {
                let jsonStr = window.fullResponse.trim();
                if (jsonStr.startsWith('```json')) jsonStr = jsonStr.substring(7);
                if (jsonStr.startsWith('```')) jsonStr = jsonStr.substring(3);
                if (jsonStr.endsWith('```')) jsonStr = jsonStr.slice(0, -3);
                jsonStr = jsonStr.trim();
                
                const spec = JSON.parse(jsonStr);
                fetch('http://localhost:8000/api/v1/generation/job/' + jobId + '/save-spec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(spec)
                }).then(r => {
                    if (r.ok) {
                        showToast('‚úÖ Sp√©cification sauvegard√©e!', 'success');
                    } else {
                        showToast('‚ùå √âchec de la sauvegarde', 'error');
                    }
                });
            } catch(e) {
                console.error('Failed to parse JSON:', e);
                showToast('‚ùå Erreur de parsing JSON: ' + e.message, 'error');
            }
        }
        
        async function previewSpec() {
            if (!jobId) {
                showToast('‚ö†Ô∏è Veuillez compl√©ter l\'analyse d\'abord', 'error');
                return;
            }
            
            showLoading('Chargement de l\'aper√ßu...');
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/generation/job/' + jobId + '/preview', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (!response.ok) throw new Error('Failed to load preview');
                
                const data = await response.json();
                const previewSection = document.getElementById('previewSection');
                const previewContent = document.getElementById('previewContent');
                const analyticsContent = document.getElementById('analyticsContent');
                
                previewContent.innerHTML = `
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 p-6 rounded-xl border border-blue-100">
                        <h4 class="font-bold text-2xl text-gray-800 mb-2">${data.appName}</h4>
                        <p class="text-gray-600">${data.description}</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-green-50 p-6 rounded-xl text-center border border-green-100">
                            <div class="text-4xl font-bold text-green-600 mb-2">${data.entities}</div>
                            <div class="text-sm text-gray-600 font-medium">üóÑÔ∏è Entit√©s BDD</div>
                        </div>
                        <div class="bg-purple-50 p-6 rounded-xl text-center border border-purple-100">
                            <div class="text-4xl font-bold text-purple-600 mb-2">${data.endpoints}</div>
                            <div class="text-sm text-gray-600 font-medium">üîå API Endpoints</div>
                        </div>
                        <div class="bg-orange-50 p-6 rounded-xl text-center border border-orange-100">
                            <div class="text-4xl font-bold text-orange-600 mb-2">${data.pages}</div>
                            <div class="text-sm text-gray-600 font-medium">üì± Pages UI</div>
                        </div>
                    </div>
                `;
                
                // Load analytics
                loadAnalytics(data.fullSpec);
                
                previewSection.classList.remove('hidden');
                hideLoading();
                showToast('‚úÖ Aper√ßu charg√©!', 'success');
            } catch (error) {
                hideLoading();
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        async function loadAnalytics(spec) {
            try {
                const [costResp, perfResp] = await Promise.all([
                    fetch('http://localhost:8000/api/v1/advanced/analytics/cost-estimate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify(spec)
                    }),
                    fetch('http://localhost:8000/api/v1/advanced/analytics/performance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify(spec)
                    })
                ]);
                
                const cost = await costResp.json();
                const perf = await perfResp.json();
                
                const analyticsContent = document.getElementById('analyticsContent');
                analyticsContent.innerHTML = `
                    <div class="bg-blue-50 p-6 rounded-xl text-center border border-blue-100">
                        <div class="text-3xl font-bold text-blue-600 mb-2">$${cost.aws.monthly}/mois</div>
                        <div class="text-sm text-gray-600 font-medium">üí∞ Co√ªt AWS</div>
                    </div>
                    <div class="bg-green-50 p-6 rounded-xl text-center border border-green-100">
                        <div class="text-3xl font-bold text-green-600 mb-2">${perf.throughput.requests_per_second}</div>
                        <div class="text-sm text-gray-600 font-medium">‚ö° Req/sec</div>
                    </div>
                    <div class="bg-purple-50 p-6 rounded-xl text-center border border-purple-100">
                        <div class="text-3xl font-bold text-purple-600 mb-2">${perf.response_time.average_ms}ms</div>
                        <div class="text-sm text-gray-600 font-medium">üöÄ Temps moyen</div>
                    </div>
                `;
            } catch (error) {
                console.error('Analytics failed:', error);
            }
        }
        
        function openVisualEditor() {
            if (!jobId) {
                showToast('‚ö†Ô∏è Veuillez compl√©ter l\'analyse d\'abord', 'error');
                return;
            }
            window.location.href = '/editor/' + jobId;
        }
        
        async function useTemplate() {
            showLoading('Chargement des templates...');
            const templates = await fetch('http://localhost:8000/api/v1/advanced/templates').then(r => r.json());
            hideLoading();
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 modal-container';
            modal.innerHTML = `
                <div class="modal-content bg-white rounded-2xl p-6 sm:p-8 max-w-2xl shadow-2xl">
                    <h3 class="text-xl sm:text-2xl font-bold mb-6">üì¶ Choisir un template</h3>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        ${templates.map((t, i) => `
                            <div onclick="selectTemplate(${i})" class="p-3 sm:p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 cursor-pointer transition">
                                <div class="font-bold text-base sm:text-lg">${t.name}</div>
                                <div class="text-xs sm:text-sm text-gray-600">${t.description}</div>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="this.closest('.fixed').remove()" class="mt-6 w-full px-4 py-3 border rounded-xl hover:bg-gray-50 text-sm sm:text-base">
                        Annuler
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            
            window.selectTemplate = async (index) => {
                modal.remove();
                showLoading('Application du template...');
                
                const spec = await fetch(`http://localhost:8000/api/v1/advanced/templates/${templates[index].id}`).then(r => r.json());
                
                await fetch(`http://localhost:8000/api/v1/generation/job/${jobId}/save-spec`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(spec)
                });
                
                hideLoading();
                showToast('‚úÖ Template appliqu√©!', 'success');
                setTimeout(() => location.reload(), 1000);
            };
        }
        
        async function addIntegration(type) {
            const integrationNames = { oauth: 'OAuth', stripe: 'Stripe' };
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 modal-container';
            modal.innerHTML = `
                <div class="modal-content bg-white rounded-2xl p-6 sm:p-8 max-w-md shadow-2xl">
                    <h3 class="text-xl sm:text-2xl font-bold mb-4">Ajouter ${integrationNames[type]}</h3>
                    <p class="text-sm sm:text-base text-gray-600 mb-6">Cette int√©gration sera ajout√©e au code g√©n√©r√©.</p>
                    <div class="flex gap-3">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 border rounded-xl hover:bg-gray-50 text-sm sm:text-base">
                            Annuler
                        </button>
                        <button onclick="confirmIntegration('${type}')" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 text-sm sm:text-base">
                            Confirmer
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            window.confirmIntegration = async (type) => {
                modal.remove();
                showLoading('Ajout de l\'int√©gration...');
                
                const endpoint = type === 'oauth' ? 'add-oauth' : 'add-stripe';
                const payload = type === 'oauth' ? {provider: 'google', code: '# Backend code'} : {code: '# Backend code'};
                
                const response = await fetch(`http://localhost:8000/api/v1/advanced/assistant/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(payload)
                });
                
                hideLoading();
                
                if (response.ok) {
                    showToast(`‚úÖ ${integrationNames[type]} sera ajout√© au code!`, 'success');
                } else {
                    showToast('‚ùå Erreur lors de l\'ajout', 'error');
                }
            };
        }
        
        async function runSecurityScan() {
            if (!jobId) {
                showToast('‚ö†Ô∏è G√©n√©rez d\'abord le projet', 'error');
                return;
            }
            
            const resultsDiv = document.getElementById('securityResults');
            resultsDiv.innerHTML = '<div class="text-center p-6 bg-gray-50 rounded-xl"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div><p class="text-gray-600">Scan de s√©curit√© en cours...</p></div>';
            resultsDiv.classList.remove('hidden');
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/advanced/security/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({code: '# Generated code', language: 'python'})
                });
                
                const result = await response.json();
                const scoreColor = result.score >= 80 ? 'green' : result.score >= 60 ? 'yellow' : 'red';
                
                resultsDiv.innerHTML = `
                    <div class="bg-white p-6 rounded-xl border-2 border-${scoreColor}-200">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold text-xl">Score de s√©curit√©</h4>
                            <div class="text-4xl font-bold text-${scoreColor}-600">${result.score}/100</div>
                        </div>
                        ${result.issues.length === 0 ? 
                            '<div class="flex items-center gap-2 text-green-600 bg-green-50 p-4 rounded-lg"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="font-medium">‚úÖ Aucun probl√®me d√©tect√©!</span></div>' : 
                            '<div class="space-y-2">' + result.issues.map(i => `
                                <div class="flex items-start gap-2 p-3 bg-red-50 rounded-lg border border-red-200">
                                    <svg class="w-5 h-5 text-red-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                    <div>
                                        <div class="font-medium text-red-800">${i.type}</div>
                                        <div class="text-sm text-red-600">${i.description}</div>
                                    </div>
                                </div>
                            `).join('') + '</div>'
                        }
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = '<div class="text-red-600 bg-red-50 p-4 rounded-xl">‚ùå √âchec du scan</div>';
            }
        }
        
        const generationSteps = [
            { icon: 'üìã', text: 'Analyse des sp√©cifications', duration: 2000 },
            { icon: 'üóÑÔ∏è', text: 'G√©n√©ration des mod√®les de base de donn√©es', duration: 3000 },
            { icon: '‚ö°', text: 'Cr√©ation des endpoints API FastAPI', duration: 3500 },
            { icon: 'üé®', text: 'G√©n√©ration du frontend Flask', duration: 3000 },
            { icon: 'üê≥', text: 'Configuration Docker & Docker Compose', duration: 2500 },
            { icon: '‚ò∏Ô∏è', text: 'Cr√©ation des manifests Kubernetes', duration: 2000 },
            { icon: 'üîß', text: 'Configuration Terraform (AWS)', duration: 2500 },
            { icon: 'üìä', text: 'Setup monitoring (Prometheus/Grafana)', duration: 2000 },
            { icon: 'üîê', text: 'Analyse de s√©curit√© OWASP', duration: 2500 },
            { icon: 'üß™', text: 'G√©n√©ration des tests unitaires', duration: 2000 },
            { icon: 'üìù', text: 'Cr√©ation de la documentation', duration: 1500 },
            { icon: 'üì¶', text: 'Compression du projet', duration: 1500 }
        ];
        
        function showGenerationProgress() {
            const modal = document.getElementById('generationModal');
            const stepsContainer = document.getElementById('generationSteps');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            modal.classList.remove('hidden');
            stepsContainer.innerHTML = '';
            
            generationSteps.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.id = `step-${index}`;
                stepDiv.className = 'flex items-center gap-3 p-4 rounded-xl bg-gray-50 opacity-50 transition-all';
                stepDiv.innerHTML = `
                    <span class="text-3xl">${step.icon}</span>
                    <span class="flex-1 text-sm font-medium text-gray-700">${step.text}</span>
                    <span class="step-status text-gray-400">‚è≥</span>
                `;
                stepsContainer.appendChild(stepDiv);
            });
        }
        
        async function animateGenerationSteps() {
            const totalSteps = generationSteps.length;
            
            for (let i = 0; i < totalSteps; i++) {
                const stepDiv = document.getElementById(`step-${i}`);
                const status = stepDiv.querySelector('.step-status');
                
                // Activer l'√©tape
                stepDiv.classList.remove('opacity-50', 'bg-gray-50');
                stepDiv.classList.add('bg-blue-50', 'border-2', 'border-blue-300', 'shadow-sm');
                status.textContent = '‚è≥';
                status.className = 'step-status text-blue-500 animate-pulse text-xl';
                
                // Attendre
                await new Promise(resolve => setTimeout(resolve, generationSteps[i].duration));
                
                // Compl√©ter l'√©tape
                stepDiv.classList.remove('bg-blue-50', 'border-blue-300');
                stepDiv.classList.add('bg-green-50', 'border-2', 'border-green-300');
                status.textContent = '‚úÖ';
                status.className = 'step-status text-green-600 text-xl';
                
                // Mettre √† jour la barre de progression
                const progress = ((i + 1) / totalSteps) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = Math.round(progress) + '%';
            }
        }
        
        async function generateCode() {
            if (!jobId) {
                showToast('‚ö†Ô∏è Veuillez compl√©ter l\'analyse d\'abord', 'error');
                return;
            }
            
            try {
                showGenerationProgress();
                
                const animationPromise = animateGenerationSteps();
                const generationPromise = fetch('http://localhost:8000/api/v1/generation/job/' + jobId + '/generate', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                const [_, response] = await Promise.all([animationPromise, generationPromise]);
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error('Generation failed: ' + error);
                }
                
                document.getElementById('generationModal').classList.add('hidden');
                showToast('‚úÖ G√©n√©ration termin√©e!', 'success');
                
                setTimeout(() => {
                    window.location.href = '/editor/' + jobId;
                }, 1500);
            } catch (error) {
                console.error('Generation error:', error);
                document.getElementById('generationModal').classList.add('hidden');
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        function openExistingEditor() {
            // Afficher le modal de chargement
            const modal = document.getElementById('projectsModal');
            const list = document.getElementById('projectsList');
            list.innerHTML = '<div class="text-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div><p class="mt-2 text-gray-600">Chargement...</p></div>';
            modal.classList.remove('hidden');
            
            // Charger les jobs
            fetch('http://localhost:8000/api/v1/generation/jobs?project_id=' + projectId, {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(r => r.json())
            .then(data => {
                const jobs = Array.isArray(data) ? data : [];
                
                if (jobs.length === 0) {
                    list.innerHTML = '<div class="text-center p-8 text-gray-500">üìÅ Aucun projet g√©n√©r√©<br><small>Veuillez d\'abord g√©n√©rer un projet</small></div>';
                    return;
                }
                
                // Afficher la liste
                list.innerHTML = jobs.map((job, index) => {
                    const date = new Date(job.created_at).toLocaleString('fr-FR');
                    const statusColor = job.status === 'COMPLETED' ? 'green' : job.status === 'FAILED' ? 'red' : 'yellow';
                    const statusIcon = job.status === 'COMPLETED' ? '‚úÖ' : job.status === 'FAILED' ? '‚ùå' : '‚è≥';
                    
                    return `
                        <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition" onclick="openEditor('${job.id}')">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-lg">${statusIcon} Version ${jobs.length - index}</div>
                                    <div class="text-sm text-gray-600">üìÖ ${date}</div>
                                </div>
                                <div>
                                    <span class="px-3 py-1 rounded-full text-sm bg-${statusColor}-100 text-${statusColor}-700">${job.status}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            })
            .catch(err => {
                console.error('Error:', err);
                list.innerHTML = '<div class="text-center p-8 text-red-500">‚ùå Erreur de chargement</div>';
            });
        }
        
        function closeProjectsModal() {
            document.getElementById('projectsModal').classList.add('hidden');
        }
        
        function openEditor(jobId) {
            window.location.href = '/editor/' + jobId;
        }
    </script>
</body>
</html>
