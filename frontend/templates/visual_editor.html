<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Editor - AutoDev</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/yaml/yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body { margin: 0; overflow: hidden; background: #1e1e1e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .editor-container { display: flex; height: 100vh; }
        .sidebar { width: 250px; background: #252526; border-right: 1px solid #3e3e42; overflow-y: auto; }
        .main-area { flex: 1; display: flex; flex-direction: column; }
        .top-bar { height: 50px; background: #323233; border-bottom: 1px solid #3e3e42; display: flex; align-items: center; padding: 0 1rem; gap: 0.5rem; }
        .tabs-bar { height: 40px; background: #2d2d30; border-bottom: 1px solid #3e3e42; display: flex; overflow-x: auto; }
        .tab { padding: 0 1rem; height: 100%; display: flex; align-items: center; gap: 0.5rem; background: #2d2d30; color: #969696; border-right: 1px solid #3e3e42; cursor: pointer; font-size: 13px; white-space: nowrap; }
        .tab.active { background: #1e1e1e; color: #fff; }
        .tab:hover { background: #2a2d2e; }
        .tab-close { opacity: 0.6; margin-left: 0.5rem; }
        .tab-close:hover { opacity: 1; }
        .editor-wrapper { flex: 1; position: relative; overflow: hidden; display: flex; }
        .CodeMirror { height: 100% !important; font-size: 14px; font-family: 'Consolas', 'Monaco', monospace; width: 100%; }
        .CodeMirror-scroll { overflow-y: auto !important; overflow-x: auto !important; }
        .file-item { padding: 0.5rem 1rem; color: #cccccc; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 0.5rem; }
        .file-item:hover { background: #2a2d2e; }
        .file-item.active { background: #37373d; }
        .folder-header { padding: 0.5rem 1rem; color: #cccccc; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 1rem; }
        .btn-editor { padding: 0.5rem 1rem; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer; border: none; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
        .btn-primary { background: #0e639c; color: white; }
        .btn-primary:hover { background: #1177bb; }
        .btn-success { background: #0e7a0d; color: white; }
        .btn-success:hover { background: #14a50d; }
        .btn-secondary { background: #3e3e42; color: #cccccc; }
        .btn-secondary:hover { background: #505053; }
        .status-bar { height: 24px; background: #007acc; color: white; display: flex; align-items: center; padding: 0 1rem; font-size: 12px; gap: 1rem; }
        .icon { width: 16px; height: 16px; }
        .search-box { background: #3c3c3c; border: 1px solid #3e3e42; color: #cccccc; padding: 0.4rem 0.8rem; border-radius: 4px; font-size: 13px; width: 200px; }
        .search-box:focus { outline: none; border-color: #007acc; }
        .no-code-panel { width: 350px; background: #252526; border-left: 1px solid #3e3e42; overflow-y: auto; padding: 1rem; }
        .panel-section { background: #2d2d30; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; }
        .panel-title { color: #cccccc; font-weight: 600; font-size: 13px; margin-bottom: 0.75rem; }
        .panel-input { width: 100%; background: #3c3c3c; border: 1px solid #3e3e42; color: #cccccc; padding: 0.5rem; border-radius: 4px; font-size: 13px; margin-bottom: 0.5rem; }
        .panel-input:focus { outline: none; border-color: #007acc; }
        .panel-btn { width: 100%; padding: 0.6rem; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer; border: none; }
        .sidebar-header { padding: 1rem; border-bottom: 1px solid #3e3e42; color: #cccccc; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #424242; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #4e4e4e; }
    </style>
</head>
<body>
    <div class="editor-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">üìÅ Explorateur</div>
            <input type="text" class="search-box" placeholder="Rechercher..." style="margin: 0.5rem; width: calc(100% - 1rem);" id="searchFiles">
            <div id="fileTree"></div>
        </div>
        
        <!-- Main Area -->
        <div class="main-area">
            <!-- Top Bar -->
            <div class="top-bar">
                <button onclick="saveChanges()" class="btn-editor btn-success" data-save>
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                    </svg>
                    Sauvegarder
                </button>
                <button onclick="downloadProject()" class="btn-editor btn-primary">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    T√©l√©charger
                </button>
                <button onclick="launchApp()" class="btn-editor" style="background: #16a34a; color: white;">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Lancer l'App
                </button>
                <button onclick="openAIAssistant()" class="btn-editor btn-secondary">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    AI Assistant
                </button>
                <button onclick="togglePreview()" class="btn-editor btn-secondary">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    Preview
                </button>
                <button onclick="toggleNoCode()" class="btn-editor btn-secondary">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                    </svg>
                    No-Code
                </button>
                <button onclick="autoDeployToRender()" class="btn-editor" style="background: #10b981; color: white;">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    Auto-Deploy
                </button>
                <button onclick="improveProject()" class="btn-editor" style="background: #8b5cf6; color: white;">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    üîÑ Am√©liorer avec IA
                </button>
                <div style="flex: 1;"></div>
                <a href="/project/{{ job_id.split('_')[0] if '_' in job_id else '1' }}" class="btn-editor btn-secondary">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Retour
                </a>
            </div>
            
            <!-- Tabs Bar -->
            <div class="tabs-bar" id="editorTabs"></div>
            
            <!-- Editor -->
            <div class="editor-wrapper" id="editorArea">
                <textarea id="codeEditor"></textarea>
            </div>
            
            <!-- Preview Panel -->
            <div id="previewPanel" style="display: none; flex: 1; background: white; border-left: 1px solid #3e3e42;">
                <div style="height: 40px; background: #2d2d30; border-bottom: 1px solid #3e3e42; display: flex; align-items: center; padding: 0 1rem; justify-content: space-between;">
                    <span style="color: #cccccc; font-size: 13px;">üëÅÔ∏è Aper√ßu en direct</span>
                    <button onclick="togglePreview()" style="background: none; border: none; color: #cccccc; cursor: pointer; font-size: 16px;">‚úï</button>
                </div>
                <iframe id="previewFrame" style="width: 100%; height: calc(100% - 40px); border: none; background: white;"></iframe>
            </div>
            
            <!-- Status Bar -->
            <div class="status-bar">
                <span id="fileStatus">üìÑ Aucun fichier ouvert</span>
                <span>|</span>
                <span id="lineCol">Ln 1, Col 1</span>
                <span>|</span>
                <span id="fileType">Text</span>
                <div style="flex: 1;"></div>
                <span>AutoDev Editor</span>
            </div>
        </div>
        
        <!-- No-Code Panel -->
        <div id="noCodePanel" class="no-code-panel" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="color: #cccccc; font-size: 14px; font-weight: 600;">üé® √âditeur Visuel</h2>
                <button onclick="toggleNoCode()" style="background: none; border: none; color: #cccccc; cursor: pointer; font-size: 18px;">‚úï</button>
            </div>
            
            <div class="panel-section">
                <div class="panel-title">‚ûï Ajouter une Entit√©</div>
                <input type="text" id="entityName" placeholder="Nom de l'entit√©" class="panel-input">
                <button onclick="addEntity()" class="panel-btn btn-primary">Ajouter</button>
            </div>
            
            <div class="panel-section">
                <div class="panel-title">‚ûï Ajouter un Champ</div>
                <select id="fieldEntity" class="panel-input"></select>
                <input type="text" id="fieldName" placeholder="Nom du champ" class="panel-input">
                <select id="fieldType" class="panel-input">
                    <option value="string">String</option>
                    <option value="integer">Integer</option>
                    <option value="boolean">Boolean</option>
                    <option value="datetime">DateTime</option>
                    <option value="text">Text</option>
                    <option value="float">Float</option>
                </select>
                <label style="color: #cccccc; font-size: 13px; display: flex; align-items: center; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="fieldRequired" style="margin-right: 0.5rem;">
                    Requis
                </label>
                <button onclick="addField()" class="panel-btn btn-success">Ajouter Champ</button>
            </div>
            
            <div class="panel-section">
                <div class="panel-title">‚ûï Ajouter un Endpoint</div>
                <select id="apiMethod" class="panel-input">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>
                <input type="text" id="apiPath" placeholder="/api/resource" class="panel-input">
                <input type="text" id="apiDesc" placeholder="Description" class="panel-input">
                <button onclick="addEndpoint()" class="panel-btn" style="background: #7c3aed; color: white;">Ajouter Endpoint</button>
            </div>
            
            <div class="panel-section">
                <div class="panel-title">ü§ñ Actions IA Rapides</div>
                <button onclick="aiAddAuth()" class="panel-btn" style="background: #0e639c; color: white; margin-bottom: 0.5rem;">Ajouter Auth</button>
                <button onclick="aiAddPayment()" class="panel-btn" style="background: #0e7a0d; color: white; margin-bottom: 0.5rem;">Ajouter Paiements</button>
                <button onclick="aiAddEmail()" class="panel-btn" style="background: #d97706; color: white;">Ajouter Email</button>
            </div>
        </div>
    </div>
    
    <script>
        const token = '{{ session.token }}';
        const jobId = '{{ job_id }}';
        let currentSpec = {};
        let currentFile = null;
        let editor = null;
        let projectFiles = {};
        let openTabs = [];
        
        window.onload = function() {
            editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
                lineNumbers: true,
                mode: 'python',
                theme: 'monokai',
                lineWrapping: true,
                indentUnit: 4,
                tabSize: 4,
                matchBrackets: true,
                autoCloseBrackets: true
            });
            editor.setSize('100%', '100%');
            editor.on('change', updateStatus);
            editor.on('cursorActivity', updateCursor);
            
            loadProject();
        };
        
        function updateStatus() {
            if (currentFile) {
                document.getElementById('fileStatus').textContent = 'üìù ' + currentFile.split('/').pop() + ' (modifi√©)';
            }
        }
        
        function updateCursor() {
            const cursor = editor.getCursor();
            document.getElementById('lineCol').textContent = `Ln ${cursor.line + 1}, Col ${cursor.ch + 1}`;
        }
        
        async function loadProject() {
            try {
                const filesResponse = await fetch(`/api/generation/job/${jobId}/files`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (filesResponse.ok) {
                    const filesData = await filesResponse.json();
                    projectFiles = filesData.files || {};
                    
                    if (Object.keys(projectFiles).length > 0) {
                        generateFileTreeFromFiles();
                        const firstFile = Object.keys(projectFiles).find(f => f.endsWith('.py')) || Object.keys(projectFiles)[0];
                        if (firstFile) loadFileFromMemory(firstFile);
                    }
                }
                
                try {
                    const response = await fetch(`/api/generation/job/${jobId}/preview`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        currentSpec = data.fullSpec || {};
                    }
                } catch (e) {
                    currentSpec = { appConfig: {name: 'My App'}, database: {entities: []}, api: {endpoints: []}, ui: {pages: []} };
                }
                
                updateNoCodeSelects();
            } catch (error) {
                console.error('Error loading project:', error);
            }
        }
        
        function generateFileTreeFromFiles() {
            const tree = document.getElementById('fileTree');
            const filesByFolder = {};
            
            Object.keys(projectFiles).forEach(path => {
                const parts = path.split('/');
                const folder = parts[0];
                if (!filesByFolder[folder]) filesByFolder[folder] = [];
                filesByFolder[folder].push(path);
            });
            
            let html = '';
            Object.keys(filesByFolder).sort().forEach(folder => {
                html += `<div class="folder-header">üìÅ ${folder}</div>`;
                filesByFolder[folder].sort().forEach(path => {
                    const fileName = path.split('/').pop();
                    const icon = getFileIcon(fileName);
                    const isActive = currentFile === path ? 'active' : '';
                    html += `<div onclick="loadFileFromMemory('${path}')" class="file-item ${isActive}">
                        <span>${icon}</span> ${fileName}
                    </div>`;
                });
            });
            tree.innerHTML = html;
        }
        
        function getFileIcon(fileName) {
            if (fileName.endsWith('.py')) return 'üêç';
            if (fileName.endsWith('.html')) return 'üìÑ';
            if (fileName.endsWith('.js')) return 'üìú';
            if (fileName.endsWith('.css')) return 'üé®';
            if (fileName.endsWith('.yml') || fileName.endsWith('.yaml')) return '‚öôÔ∏è';
            if (fileName.endsWith('.md')) return 'üìñ';
            if (fileName.endsWith('.json')) return 'üìã';
            return 'üìù';
        }
        
        function loadFileFromMemory(filename) {
            currentFile = filename;
            
            if (projectFiles[filename]) {
                editor.setValue(projectFiles[filename]);
                
                const ext = filename.split('.').pop();
                const modes = {
                    'py': 'python',
                    'html': 'htmlmixed',
                    'js': 'javascript',
                    'css': 'css',
                    'yml': 'yaml',
                    'yaml': 'yaml',
                    'md': 'markdown',
                    'json': 'javascript'
                };
                editor.setOption('mode', modes[ext] || 'text/plain');
                
                document.getElementById('fileStatus').textContent = 'üìÑ ' + filename.split('/').pop();
                document.getElementById('fileType').textContent = ext.toUpperCase();
                
                addTab(filename);
                generateFileTreeFromFiles();
                updatePreviewIfOpen();
            }
        }
        
        function addTab(filename) {
            if (!openTabs.includes(filename)) {
                openTabs.push(filename);
            }
            renderTabs();
        }
        
        function renderTabs() {
            const tabsBar = document.getElementById('editorTabs');
            tabsBar.innerHTML = openTabs.map(file => {
                const fileName = file.split('/').pop();
                const icon = getFileIcon(fileName);
                const isActive = currentFile === file ? 'active' : '';
                return `
                    <div class="tab ${isActive}" onclick="loadFileFromMemory('${file}')">
                        <span>${icon}</span>
                        <span>${fileName}</span>
                        <span class="tab-close" onclick="event.stopPropagation(); closeTab('${file}')">‚úï</span>
                    </div>
                `;
            }).join('');
        }
        
        function closeTab(filename) {
            openTabs = openTabs.filter(f => f !== filename);
            if (currentFile === filename && openTabs.length > 0) {
                loadFileFromMemory(openTabs[openTabs.length - 1]);
            } else if (openTabs.length === 0) {
                currentFile = null;
                editor.setValue('');
                document.getElementById('fileStatus').textContent = 'üìÑ Aucun fichier ouvert';
            }
            renderTabs();
        }
        
        function toggleNoCode() {
            const panel = document.getElementById('noCodePanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function updateNoCodeSelects() {
            const select = document.getElementById('fieldEntity');
            select.innerHTML = (currentSpec.database?.entities || []).map(e => 
                `<option value="${e.name}">${e.name}</option>`
            ).join('');
        }
        
        function addEntity() {
            const name = document.getElementById('entityName').value;
            if (!name) return alert('Entrez un nom d\'entit√©');
            
            if (!currentSpec.database) currentSpec.database = {entities: []};
            currentSpec.database.entities.push({ name: name, columns: [] });
            
            alert(`Entit√© "${name}" ajout√©e!`);
            updateNoCodeSelects();
            document.getElementById('entityName').value = '';
        }
        
        function addField() {
            const entity = document.getElementById('fieldEntity').value;
            const name = document.getElementById('fieldName').value;
            const type = document.getElementById('fieldType').value;
            const required = document.getElementById('fieldRequired').checked;
            
            if (!name) return alert('Entrez un nom de champ');
            
            const ent = currentSpec.database?.entities?.find(e => e.name === entity);
            if (ent) {
                ent.columns.push({name, type, required});
                alert(`Champ "${name}" ajout√© √† ${entity}!`);
                document.getElementById('fieldName').value = '';
            }
        }
        
        function addEndpoint() {
            const method = document.getElementById('apiMethod').value;
            const path = document.getElementById('apiPath').value;
            const description = document.getElementById('apiDesc').value;
            
            if (!path) return alert('Entrez un chemin');
            
            if (!currentSpec.api) currentSpec.api = {endpoints: []};
            currentSpec.api.endpoints.push({method, path, description});
            
            alert(`Endpoint ${method} ${path} ajout√©!`);
            document.getElementById('apiPath').value = '';
            document.getElementById('apiDesc').value = '';
        }
        
        async function aiAddAuth() {
            if (!confirm('Ajouter l\'authentification OAuth?')) return;
            const code = editor.getValue();
            const response = await fetch('/api/advanced/assistant/add-oauth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({provider: 'google', code})
            });
            const result = await response.json();
            editor.setValue(result.code);
            alert('OAuth ajout√©!');
        }
        
        async function aiAddPayment() {
            if (!confirm('Ajouter Stripe?')) return;
            const code = editor.getValue();
            const response = await fetch('/api/advanced/assistant/add-stripe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({code})
            });
            const result = await response.json();
            editor.setValue(result.code);
            alert('Stripe ajout√©!');
        }
        
        async function aiAddEmail() {
            const code = editor.getValue();
            const response = await fetch('/api/advanced/assistant/add-integration', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({service: 'sendgrid', code})
            });
            const result = await response.json();
            editor.setValue(result.code);
            alert('Service email ajout√©!');
        }
        
        async function openAIAssistant() {
            const question = prompt('ü§ñ AI Assistant\n\nPosez votre question:');
            if (!question) return;
            
            const response = await fetch('/api/advanced/assistant/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({question, job_id: jobId})
            });
            
            const result = await response.json();
            if (result.modified_files && result.modified_files.length > 0) {
                alert(`‚úÖ Fichiers modifi√©s:\n${result.modified_files.join('\n')}`);
                location.reload();
            } else {
                alert('ü§ñ ' + result.answer);
            }
        }
        
        async function saveChanges() {
            if (currentFile) {
                projectFiles[currentFile] = editor.getValue();
            }
            
            await fetch(`/api/generation/job/${jobId}/save-spec`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(currentSpec)
            });
            
            document.getElementById('fileStatus').textContent = '‚úÖ Sauvegard√© - ' + (currentFile ? currentFile.split('/').pop() : '');
            setTimeout(() => {
                if (currentFile) document.getElementById('fileStatus').textContent = 'üìÑ ' + currentFile.split('/').pop();
            }, 2000);
        }
        
        async function downloadProject() {
            await saveChanges();
            
            const response = await fetch(`/api/generation/download/${jobId}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (!response.ok) return alert('‚ùå Erreur');
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'project_' + jobId + '.zip';
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        async function launchApp() {
            if (!confirm('üöÄ Lancer l\'application g√©n√©r√©e?\n\nCela d√©marrera un serveur local.')) return;
            
            try {
                const response = await fetch(`/api/generation/job/${jobId}/preview-app`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (response.status === 404) {
                    alert('‚ö†Ô∏è Projet non trouv√©\n\nVeuillez d\'abord:\n1. Retourner √† la page du projet\n2. Cliquer sur "G√©n√©rer le projet"\n3. Attendre la fin de la g√©n√©ration\n4. Revenir dans l\'√©diteur');
                    return;
                }
                
                if (!response.ok) throw new Error('Erreur de d√©marrage');
                
                const data = await response.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 modal-container';
                modal.innerHTML = `
                    <div class="modal-content bg-white rounded-2xl p-8 max-w-2xl shadow-2xl" style="color: #333;">
                        <h3 class="text-2xl font-bold mb-4" style="color: #16a34a;">‚úÖ Application Compl√®te D√©marr√©e!</h3>
                        <p class="mb-4">Votre application full-stack est accessible:</p>
                        <div class="bg-gray-100 p-4 rounded-lg mb-4">
                            <div class="mb-3 p-3 bg-blue-50 border-2 border-blue-500 rounded-lg">
                                <strong class="text-blue-700">üåê FRONTEND (Cliquez ici):</strong>
                                <a href="${data.url}" target="_blank" class="text-blue-600 font-mono text-xl hover:underline block mt-1">${data.url}</a>
                            </div>
                            <div class="text-sm text-gray-600 p-2 bg-gray-50 rounded">
                                <strong>üîå Backend API (pour d√©veloppeurs):</strong> ${data.backend_url || 'http://localhost:' + data.backend_port}
                            </div>
                        </div>
                        ${data.fixed ? '<p class="text-sm text-orange-600 mb-4">‚ö° Code auto-corrig√© par l\'IA!</p>' : ''}
                        <div class="flex gap-3">
                            <button onclick="window.open('${data.url}', '_blank')" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700">
                                üåê Ouvrir l'Application
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 border rounded-xl hover:bg-gray-50">
                                Fermer
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            }
        }
        
        // Search files
        document.getElementById('searchFiles').addEventListener('input', (e) => {
            const search = e.target.value.toLowerCase();
            document.querySelectorAll('.file-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? 'flex' : 'none';
            });
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveChanges();
            }
        });
        
        // Preview functions
        function togglePreview() {
            const preview = document.getElementById('previewPanel');
            const editorArea = document.getElementById('editorArea');
            
            if (preview.style.display === 'none') {
                preview.style.display = 'block';
                editorArea.style.flex = '1';
                updatePreviewIfOpen();
            } else {
                preview.style.display = 'none';
                editorArea.style.flex = '1';
            }
        }
        
        function updatePreviewIfOpen() {
            const preview = document.getElementById('previewPanel');
            if (preview.style.display !== 'none') {
                updatePreview();
            }
        }
        
        function updatePreview() {
            const iframe = document.getElementById('previewFrame');
            const content = editor.getValue();
            
            if (currentFile && currentFile.endsWith('.html')) {
                iframe.srcdoc = content;
            } else if (currentFile && currentFile.endsWith('.md')) {
                iframe.srcdoc = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 2rem; max-width: 800px; margin: 0 auto; line-height: 1.6; }
                            pre { background: #f5f5f5; padding: 1rem; border-radius: 4px; overflow-x: auto; }
                            code { background: #f5f5f5; padding: 0.2rem 0.4rem; border-radius: 3px; }
                            h1, h2, h3 { margin-top: 1.5rem; }
                        </style>
                    </head>
                    <body>${content.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>')}</body>
                    </html>
                `;
            } else {
                const ext = currentFile ? currentFile.split('.').pop() : 'txt';
                iframe.srcdoc = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            body { margin: 0; padding: 20px; background: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; }
                            pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; }
                            .header { background: #2d2d30; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
                            .filename { color: #4ec9b0; font-weight: bold; }
                            .ext { color: #858585; margin-left: 10px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <span class="filename">${currentFile || 'Preview'}</span>
                            <span class="ext">(${ext.toUpperCase()})</span>
                        </div>
                        <pre>${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                    </body>
                    </html>
                `;
            }
        }
        
        // Update preview on editor change
        editor.on('change', () => {
            updateStatus();
            updatePreviewIfOpen();
        });
        
        // Auto-deploy to Render
        async function autoDeployToRender() {
            if (!confirm('üöÄ D√©ployer automatiquement sur Render?\n\nCela va:\n1. Cr√©er un repo GitHub\n2. Pusher le code\n3. D√©ployer sur Render\n\nVous devez avoir configur√© GITHUB_TOKEN et RENDER_API_KEY dans .env')) return;
            
            const appName = prompt('Nom de l\'application (ex: mon-app):', 'app-' + jobId.substring(0, 8));
            if (!appName) return;
            
            try {
                const response = await fetch('/api/advanced/deploy/auto', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ job_id: jobId, app_name: appName })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'D√©ploiement √©chou√©');
                }
                
                const data = await response.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 modal-container';
                modal.innerHTML = `
                    <div class="modal-content bg-white rounded-2xl p-8 max-w-2xl shadow-2xl" style="color: #333;">
                        <h3 class="text-2xl font-bold mb-4" style="color: #10b981;">‚úÖ D√©ploiement R√©ussi!</h3>
                        <div class="bg-gray-100 p-4 rounded-lg mb-4">
                            <div class="mb-3">
                                <strong>üíô GitHub:</strong>
                                <a href="${data.github_repo}" target="_blank" class="text-blue-600 hover:underline block">${data.github_repo}</a>
                            </div>
                            <div class="mb-3 p-3 bg-green-50 border-2 border-green-500 rounded-lg">
                                <strong class="text-green-700">üåê FRONTEND:</strong>
                                <a href="${data.frontend_url}" target="_blank" class="text-green-600 font-mono text-lg hover:underline block">${data.frontend_url}</a>
                            </div>
                            <div class="text-sm text-gray-600 p-2 bg-gray-50 rounded">
                                <strong>üîå Backend API:</strong> ${data.backend_url}
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">‚è≥ Le d√©ploiement prend 3-5 minutes. Rafra√Æchissez la page dans quelques instants.</p>
                        <div class="flex gap-3">
                            <button onclick="window.open('${data.frontend_url}', '_blank')" class="flex-1 px-4 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700">
                                üåê Ouvrir l'App
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 border rounded-xl hover:bg-gray-50">
                                Fermer
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message + '\n\nAssurez-vous d\'avoir configur√©:\n- GITHUB_TOKEN dans .env\n- RENDER_API_KEY dans .env');
            }
        }
        
        // üîÑ Am√©liorer le projet avec IA
        async function improveProject() {
            const feedback = prompt('üîÑ AM√âLIORER AVEC IA\n\nQue voulez-vous am√©liorer?\n\nExemples:\n- "Le design n\'est pas assez moderne"\n- "Ajoute plus d\'animations"\n- "Am√©liore la s√©curit√©"\n- "Optimise les performances"\n\nLaissez vide pour am√©lioration automatique:');
            
            if (feedback === null) return; // Annul√©
            
            // Sauvegarder d'abord
            await saveChanges();
            
            // Afficher modal de progression
            const progressModal = document.createElement('div');
            progressModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 modal-container';
            progressModal.innerHTML = `
                <div class="modal-content bg-white rounded-2xl p-8 max-w-2xl shadow-2xl" style="color: #333;">
                    <h3 class="text-2xl font-bold mb-4" style="color: #8b5cf6;">üîÑ Am√©lioration en cours...</h3>
                    <div class="mb-4">
                        <div class="bg-gray-200 rounded-full h-2 mb-2">
                            <div id="progressBar" class="bg-purple-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <p id="progressText" class="text-sm text-gray-600">Analyse du projet...</p>
                    </div>
                    <div class="space-y-2 text-sm text-gray-600">
                        <div id="step1" class="flex items-center gap-2">
                            <span class="text-2xl">‚è≥</span>
                            <span>1. Analyse du projet existant</span>
                        </div>
                        <div id="step2" class="flex items-center gap-2">
                            <span class="text-2xl">‚è≥</span>
                            <span>2. G√©n√©ration des am√©liorations</span>
                        </div>
                        <div id="step3" class="flex items-center gap-2">
                            <span class="text-2xl">‚è≥</span>
                            <span>3. Application des changements</span>
                        </div>
                        <div id="step4" class="flex items-center gap-2">
                            <span class="text-2xl">‚è≥</span>
                            <span>4. Validation qualit√©</span>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressModal);
            
            try {
                // Simuler progression
                const updateProgress = (step, percent, text) => {
                    document.getElementById('progressBar').style.width = percent + '%';
                    document.getElementById('progressText').textContent = text;
                    for (let i = 1; i <= 4; i++) {
                        const el = document.getElementById('step' + i);
                        if (i < step) {
                            el.querySelector('span').textContent = '‚úÖ';
                        } else if (i === step) {
                            el.querySelector('span').textContent = '‚è≥';
                        }
                    }
                };
                
                updateProgress(1, 25, 'Analyse du projet par 13 agents IA...');
                
                const response = await fetch(`/api/generation/job/${jobId}/improve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ feedback: feedback || 'Am√©lioration g√©n√©rale' })
                });
                
                updateProgress(2, 50, 'G√©n√©ration des am√©liorations...');
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Am√©lioration √©chou√©e');
                }
                
                updateProgress(3, 75, 'Application des changements...');
                
                const data = await response.json();
                
                updateProgress(4, 100, 'Validation termin√©e!');
                
                // Attendre un peu pour montrer la compl√©tion
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Fermer modal de progression
                progressModal.remove();
                
                // Afficher r√©sultats
                const resultModal = document.createElement('div');
                resultModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 modal-container';
                resultModal.innerHTML = `
                    <div class="modal-content bg-white rounded-2xl p-8 max-w-2xl shadow-2xl" style="color: #333;">
                        <h3 class="text-2xl font-bold mb-4" style="color: #10b981;">‚úÖ Projet Am√©lior√©!</h3>
                        <div class="bg-gray-100 p-4 rounded-lg mb-4">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="bg-white p-3 rounded-lg">
                                    <div class="text-3xl font-bold text-purple-600">${data.improvements_count}</div>
                                    <div class="text-sm text-gray-600">Am√©liorations g√©n√©r√©es</div>
                                </div>
                                <div class="bg-white p-3 rounded-lg">
                                    <div class="text-3xl font-bold text-green-600">${data.applied_count}</div>
                                    <div class="text-sm text-gray-600">Fichiers modifi√©s</div>
                                </div>
                            </div>
                            <div class="bg-purple-50 p-3 rounded-lg mb-3">
                                <strong class="text-purple-700">Score Qualit√©:</strong>
                                <div class="text-2xl font-bold text-purple-600">${data.validation?.quality_score || 90}/100</div>
                            </div>
                            <div class="text-sm text-gray-600">
                                <strong>Impact:</strong> ${data.validation?.impact || 'medium'}<br>
                                <strong>Am√©lioration:</strong> ${data.validation?.overall_improvement || '+10 points'}
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">üí° Votre projet a √©t√© am√©lior√© par 13 agents IA sp√©cialis√©s!</p>
                        <div class="flex gap-3">
                            <button onclick="location.reload()" class="flex-1 px-4 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700">
                                üîÑ Recharger l'√âditeur
                            </button>
                            <button onclick="downloadProject()" class="flex-1 px-4 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700">
                                üì• T√©l√©charger
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="px-4 py-3 border rounded-xl hover:bg-gray-50">
                                Fermer
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(resultModal);
                
            } catch (error) {
                progressModal.remove();
                alert('‚ùå Erreur: ' + error.message);
            }
        }
    </script>
</body>
</html>
